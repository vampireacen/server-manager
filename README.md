# 🖥️ 服务器管理系统 (Server Management System)

一个基于Flask的Linux服务器管理平台，提供实时监控、用户权限管理和自动化服务器配置功能。

## ✨ 功能特性

### 🔍 核心功能
- 🖥️ **服务器监控**: 实时监控CPU、内存、磁盘使用情况
- 📊 **图表展示**: 使用Chart.js展示监控数据和历史趋势  
- 👥 **用户管理**: 支持普通用户和管理员角色
- 📋 **权限申请**: 用户可申请不同类型的服务器权限
- ✅ **审核流程**: 管理员可审核通过或拒绝申请
- 🔔 **通知提醒**: 管理员收到新申请的实时通知
- 🤖 **自动化配置**: 权限批准后自动在服务器上创建用户和配置权限
- 📋 **操作日志**: 详细记录所有服务器操作和权限变更

### 🔐 权限类型与自动化配置
- **普通用户**: 基本SSH访问权限，自动创建Linux用户
- **管理员权限**: sudo权限和系统管理，自动添加到sudo组
- **Docker权限**: Docker容器管理权限，自动添加到docker组
- **数据库权限**: 数据库访问和管理权限，自动添加到database组  
- **自定义权限**: 其他特殊权限需求，可配置特定组权限

### 🛡️ 安全特性
- 输入验证和SQL注入防护
- 命令注入防护和安全命令检查
- 用户名和组名合法性验证
- SSH连接安全验证和超时控制
- 操作审计日志记录

## 🛠️ 技术栈
- **后端**: Python + Flask + SQLAlchemy + SQLite
- **前端**: HTML + Bootstrap 5 + Chart.js + jQuery
- **SSH操作**: paramiko (SSH连接和命令执行)
- **认证**: Session-based认证
- **安全**: shlex命令参数转义，正则表达式验证
- **日志**: Python logging模块，自定义操作日志系统

## 安装部署

### 1. 环境要求
- Python 3.7+
- pip

### 2. 安装依赖
```bash
pip install -r requirements.txt
```

### 3. 运行应用
```bash
python app.py
```

应用将在 http://localhost:8080 启动

### 4. 默认登录
- 用户名: admin
- 密码: admin123

## 📖 使用指南

### 👨‍💼 管理员操作流程
1. **添加服务器**: 在"管理 → 服务器管理"中添加要监控的服务器
2. **配置权限**: 系统预设了5种权限类型，可根据需要调整
3. **审核申请**: 在"管理 → 审核申请"中处理用户的权限申请
4. **自动化配置**: 批准申请后系统自动在目标服务器创建用户和配置权限
5. **监控查看**: 在控制台实时查看所有服务器状态
6. **权限撤销**: 可以撤销已批准的权限，自动移除服务器端权限

### 👤 普通用户操作流程
1. **注册账户**: 填写学号、实验室等信息注册账户
2. **查看服务器**: 在控制台查看可用服务器的监控状态
3. **申请权限**: 点击"申请权限"选择服务器和权限类型
4. **跟踪申请**: 在"我的申请"中查看申请状态和审核结果
5. **获取访问**: 权限批准后获得SSH连接信息和自动生成的密码
6. **一键连接**: 使用一键复制功能快速获取SSH连接命令

### 🔄 自动化权限配置流程
1. 管理员批准申请
2. 系统SSH连接到目标服务器
3. 检查用户是否存在，不存在则自动创建
4. 生成安全随机密码
5. 根据权限类型自动配置：
   - 普通用户：创建基本用户账户
   - 管理员权限：添加到sudo组
   - Docker权限：添加到docker组
   - 数据库权限：添加到database组
6. 记录详细操作日志
7. 在用户界面显示连接信息

### 监控功能
- **实时数据**: 每30秒自动更新监控数据
- **历史图表**: 点击服务器详情查看6小时历史趋势
- **状态指示**: 在线(绿色)、离线(红色)、未知(灰色)

## 📁 项目结构
```
server-manage/
├── app.py                  # Flask主应用，路由和业务逻辑
├── models.py               # SQLAlchemy数据库模型
├── server_monitor.py       # 服务器监控逻辑
├── server_operations.py    # 🆕 服务器用户管理和权限配置
├── operation_log.py        # 🆕 操作日志记录系统
├── config.py               # 应用配置
├── requirements.txt        # Python依赖包
├── CLAUDE.md               # AI助手项目指导文档
├── README.md               # 项目说明文档
├── instance/
│   └── database.db         # SQLite数据库(运行后生成)
├── logs/                   # 🆕 操作日志目录(运行后生成)
│   ├── server_operations.log       # 操作日志
│   └── server_operations_error.log # 错误日志
├── templates/              # Jinja2 HTML模板
│   ├── base.html           # 基础模板
│   ├── login.html          # 登录页面
│   ├── dashboard.html      # 管理员控制台
│   ├── user_dashboard.html # 🆕 用户控制台
│   ├── apply.html          # 权限申请页面
│   ├── my_applications.html # 我的申请
│   ├── admin_review.html   # 管理员审核页面
│   ├── admin_servers.html  # 服务器管理
│   └── admin_users.html    # 用户管理
└── static/                 # 静态资源文件
    ├── css/
    │   └── claude-style.css # 🆕 自定义样式
    └── js/                 # JavaScript文件
```

## 🗄️ 数据库表结构
- **users**: 用户信息、认证和角色管理
- **servers**: 服务器SSH连接配置信息
- **permission_types**: 权限类型定义和描述
- **applications**: 用户权限申请记录和审核状态
- **server_metrics**: 服务器监控数据时序存储
- **notifications**: 管理员通知和消息队列

### 核心数据关系
- 用户(User) → 多个申请(Application)
- 服务器(Server) → 多个申请(Application) + 多个监控数据(ServerMetric)
- 申请(Application) 关联 用户(User) + 服务器(Server) + 权限类型(PermissionType)
- 通知(Notification) 提醒管理员关于申请(Application)

## 配置说明

### SSH连接配置
在添加服务器时需要提供：
- 服务器名称（显示名称）
- 主机地址（IP或域名）
- SSH端口（默认22）
- 用户名
- 密码（目前仅支持密码认证）

### 监控数据收集
系统通过SSH连接执行以下命令收集监控数据：
- CPU使用率: `top -bn1` 或 `/proc/stat`
- 内存使用率: `free`
- 磁盘使用率: `df -h /`
- 系统负载: `uptime`

## 🔒 安全注意事项

### 基础安全
1. **修改默认密码**: 部署后立即修改admin默认密码
2. **SSH连接安全**: 目标服务器建议配置SSH密钥认证
3. **HTTPS加密**: 生产环境建议配置HTTPS和SSL证书
4. **防火墙配置**: 限制应用访问来源IP和端口
5. **定期备份**: 定期备份数据库文件和操作日志

### 应用内安全机制
- ✅ **输入验证**: 用户名、组名格式验证
- ✅ **命令注入防护**: shlex参数转义和危险命令检测
- ✅ **SQL注入防护**: SQLAlchemy ORM防护
- ✅ **会话安全**: Flask session认证和超时
- ✅ **权限控制**: 角色基础访问控制(RBAC)
- ✅ **操作审计**: 详细的操作日志记录

### 服务器端安全要求
- 目标服务器需要独立的管理用户账户
- 建议使用专用管理用户而非root用户
- 定期审查和清理不活跃的用户账户
- 监控异常登录和权限使用情况

## 🔧 故障排除

### 常见问题
1. **SSH连接失败**: 
   - 检查服务器地址、端口、用户名密码是否正确
   - 确认目标服务器SSH服务运行正常
   - 检查网络连通性和防火墙设置

2. **监控数据为空**: 
   - 确保SSH用户有执行监控命令的权限
   - 检查目标服务器是否安装了必要的命令工具
   - 查看logs/server_operations_error.log了解具体错误

3. **自动权限配置失败**:
   - 检查SSH用户是否有sudo权限
   - 确认目标服务器支持所需的用户管理命令
   - 查看操作日志确认具体失败原因

4. **页面无法访问**: 
   - 检查Flask应用是否正常启动
   - 确认端口8080没有被其他程序占用
   - 检查防火墙设置和端口开放情况

### 📋 日志系统
- **应用日志**: 控制台输出Flask应用运行日志
- **操作日志**: `logs/server_operations.log` 记录所有服务器操作
- **错误日志**: `logs/server_operations_error.log` 记录操作错误
- **日志轮转**: 超过30天的日志会自动归档

### 🔍 调试技巧
- 启用Flask调试模式查看详细错误信息
- 使用浏览器开发者工具检查前端错误
- 检查数据库连接和表结构是否正确
- 手动测试SSH连接验证凭据正确性

## 🚀 扩展开发

系统采用模块化设计，支持灵活扩展：

### 功能扩展
- **权限类型**: 在`models.py`中添加新的权限类型定义
- **监控指标**: 扩展`server_monitor.py`增加新的监控数据采集
- **认证方式**: 集成LDAP、AD或OAuth2认证系统
- **通知渠道**: 添加邮件、短信、钉钉等通知方式
- **API接口**: 提供RESTful API供第三方系统集成

### 安全增强
- **SSH密钥**: 支持SSH公钥认证替代密码认证
- **多因子认证**: 集成TOTP或短信验证码
- **权限细化**: 实现更细粒度的权限控制
- **审计增强**: 增加用户行为分析和异常检测

### 性能优化
- **数据库**: 迁移到PostgreSQL或MySQL
- **缓存系统**: 集成Redis缓存监控数据
- **异步处理**: 使用Celery处理耗时的SSH操作
- **负载均衡**: 支持多实例部署和负载均衡

### 开发指南
1. 遵循现有的代码结构和命名规范
2. 新功能需要添加相应的测试用例
3. 数据库变更需要提供迁移脚本
4. 更新CLAUDE.md文档指导AI助手

## 📄 许可证
MIT License - 详见LICENSE文件

## 👥 贡献
欢迎提交Issue和Pull Request来改进这个项目！

### 贡献指南
1. Fork项目到你的GitHub账户
2. 创建功能分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启Pull Request

---
📧 如有问题或建议，请创建Issue或联系项目维护者。