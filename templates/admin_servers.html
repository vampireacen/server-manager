{% extends "base.html" %}

{% block title %}服务器管理 - 服务器管理系统{% endblock %}

{% block content %}
<!-- 页面头部 -->
<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h1 class="h3 mb-2" style="color: var(--claude-text-primary); font-weight: 600;">
            <i class="bi bi-server me-2" style="color: var(--claude-primary);"></i>
            服务器管理
        </h1>
        <p class="text-muted mb-0">添加、编辑和管理服务器连接信息</p>
    </div>
    <div class="d-flex align-items-center gap-2">
        <button class="claude-btn claude-btn-primary" data-bs-toggle="modal" data-bs-target="#addServerModal">
            <i class="bi bi-plus-circle"></i>
            <span class="d-none d-md-inline ms-2">添加服务器</span>
        </button>
    </div>
</div>

<!-- 服务器统计 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="claude-metric-card">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <div class="claude-metric-value">{{ servers|length }}</div>
                    <div class="claude-metric-label">总服务器</div>
                </div>
                <i class="bi bi-server" style="font-size: 2rem; color: var(--claude-primary); opacity: 0.7;"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="claude-metric-card">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <div class="claude-metric-value" style="color: var(--claude-success);">
                        {{ servers|selectattr('status', 'equalto', 'online')|list|length }}
                    </div>
                    <div class="claude-metric-label">在线</div>
                </div>
                <i class="bi bi-check-circle" style="font-size: 2rem; color: var(--claude-success); opacity: 0.7;"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="claude-metric-card">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <div class="claude-metric-value" style="color: var(--claude-danger);">
                        {{ servers|selectattr('status', 'equalto', 'offline')|list|length }}
                    </div>
                    <div class="claude-metric-label">离线</div>
                </div>
                <i class="bi bi-x-circle" style="font-size: 2rem; color: var(--claude-danger); opacity: 0.7;"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="claude-metric-card">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <div class="claude-metric-value" style="color: var(--claude-text-muted);">
                        {{ servers|selectattr('status', 'equalto', 'unknown')|list|length }}
                    </div>
                    <div class="claude-metric-label">未知</div>
                </div>
                <i class="bi bi-question-circle" style="font-size: 2rem; color: var(--claude-text-muted); opacity: 0.7;"></i>
            </div>
        </div>
    </div>
</div>

{% if servers %}
<!-- 服务器列表 -->
<div class="claude-card">
    <div class="claude-card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0" style="color: var(--claude-text-primary); font-weight: 600;">
                <i class="bi bi-list me-2" style="color: var(--claude-primary);"></i>
                服务器列表
            </h5>
            <div class="server-search-controls d-flex gap-2">
                <div class="input-group" style="width: 280px;">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" id="serverSearchInput" placeholder="搜索服务器名称或地址...">
                    <button class="btn btn-outline-secondary" type="button" id="clearSearchBtn" style="display: none;">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="dropdown">
                    <button class="claude-btn claude-btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-funnel"></i>
                        筛选
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item filter-status" href="#" data-status="all">全部状态</a></li>
                        <li><a class="dropdown-item filter-status" href="#" data-status="online">在线</a></li>
                        <li><a class="dropdown-item filter-status" href="#" data-status="offline">离线</a></li>
                        <li><a class="dropdown-item filter-status" href="#" data-status="unknown">未知</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="claude-card-body">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="color: var(--claude-text-secondary); font-weight: 600;">服务器信息</th>
                        <th style="color: var(--claude-text-secondary); font-weight: 600;">连接配置</th>
                        <th style="color: var(--claude-text-secondary); font-weight: 600;">状态</th>
                        <th style="color: var(--claude-text-secondary); font-weight: 600;">添加时间</th>
                        <th style="color: var(--claude-text-secondary); font-weight: 600;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for server in servers %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-server me-3" style="color: var(--claude-primary); font-size: 1.2rem;"></i>
                                <div>
                                    <div class="fw-semibold" style="color: var(--claude-text-primary);">{{ server.name }}</div>
                                    <small class="text-muted">{{ server.host }}</small>
                                    {% if server.location or server.datacenter %}
                                    <br><small class="text-muted">
                                        <i class="bi bi-geo-alt me-1"></i>
                                        {% if server.location %}{{ server.location }}{% endif %}
                                        {% if server.location and server.datacenter %} - {% endif %}
                                        {% if server.datacenter %}{{ server.datacenter }}{% endif %}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="server-config-info">
                                <div><strong>端口:</strong> <code class="claude-code">{{ server.port }}</code></div>
                                <div class="mt-1"><strong>用户:</strong> <code class="claude-code">{{ server.username }}</code></div>
                                <div class="mt-1">
                                    <strong>认证:</strong> 
                                    {% if server.auth_type == 'key' %}
                                        <span class="claude-badge claude-badge-info">
                                            <i class="bi bi-file-earmark-lock"></i>密钥
                                        </span>
                                    {% else %}
                                        <span class="claude-badge claude-badge-secondary">
                                            <i class="bi bi-key"></i>密码
                                        </span>
                                    {% endif %}
                                </div>
                                {% if server.cpu_model or server.memory_count %}
                                <div class="mt-2 text-muted small">
                                    {% if server.cpu_model %}
                                    <div><i class="bi bi-cpu me-1"></i>{{ server.cpu_model }}{% if server.cpu_count %} x{{ server.cpu_count }}{% endif %}</div>
                                    {% endif %}
                                    {% if server.memory_count %}
                                    <div><i class="bi bi-memory me-1"></i>{{ server.memory_count }}GB{% if server.memory_model %} {{ server.memory_model }}{% endif %}</div>
                                    {% endif %}
                                    {% if server.gpu_model %}
                                    <div><i class="bi bi-gpu-card me-1"></i>{{ server.gpu_model }}{% if server.gpu_count %} x{{ server.gpu_count }}{% endif %}</div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="claude-badge claude-badge-{{ 'success' if server.status == 'online' else 'danger' if server.status == 'offline' else 'secondary' }}">
                                <i class="bi bi-{{ 'check-circle' if server.status == 'online' else 'x-circle' if server.status == 'offline' else 'question-circle' }}"></i>
                                {{ '在线' if server.status == 'online' else '离线' if server.status == 'offline' else '未知' }}
                            </span>
                        </td>
                        <td>
                            <small class="text-muted">{{ server.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </td>
                        <td>
                            <div class="btn-group">
                                <button class="claude-btn claude-btn-sm claude-btn-secondary" onclick="testConnection({{ server.id }})" title="测试连接">
                                    <i class="bi bi-wifi"></i>
                                </button>
                                <button class="claude-btn claude-btn-sm claude-btn-secondary" onclick="editServerById({{ server.id }})" title="编辑服务器">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="claude-btn claude-btn-sm claude-btn-danger" onclick="deleteServer({{ server.id }}, '{{ server.name }}')" title="删除服务器">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<!-- 空状态 -->
<div class="claude-card text-center py-5">
    <div class="claude-card-body">
        <i class="bi bi-server" style="font-size: 4rem; color: var(--claude-text-muted); opacity: 0.5;"></i>
        <h4 class="mt-3 mb-2" style="color: var(--claude-text-secondary);">暂无服务器</h4>
        <p class="text-muted mb-3">还没有添加任何服务器，立即添加第一台服务器开始管理。</p>
        <button class="claude-btn claude-btn-primary" data-bs-toggle="modal" data-bs-target="#addServerModal">
            <i class="bi bi-plus-circle"></i>
            添加服务器
        </button>
    </div>
</div>
{% endif %}

<!-- 添加服务器模态框 -->
<div class="modal fade" id="addServerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content claude-modal">
            <div class="modal-header">
                <h5 class="modal-title" style="color: var(--claude-text-primary); font-weight: 600;">
                    <i class="bi bi-plus-circle me-2" style="color: var(--claude-primary);"></i>
                    添加服务器
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="addServerForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">服务器名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control claude-input" id="name" name="name" required>
                        <div class="form-text">给服务器一个易识别的名称</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="host" class="form-label">主机地址 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control claude-input" id="host" name="host" 
                               placeholder="192.168.1.100 或 server.example.com" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="port" class="form-label">SSH端口</label>
                        <input type="number" class="form-control claude-input" id="port" name="port" value="22" min="1" max="65535">
                    </div>
                    
                    <div class="mb-3">
                        <label for="username" class="form-label">用户名 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control claude-input" id="username" name="username" required>
                    </div>
                    
                    <!-- 认证类型选择 -->
                    <div class="mb-3">
                        <label class="form-label">认证方式 <span class="text-danger">*</span></label>
                        <div class="auth-type-selection">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="auth_type" id="auth_password" value="password" checked onchange="toggleAuthFields()">
                                <label class="form-check-label" for="auth_password">
                                    <i class="bi bi-key me-1"></i>密码认证
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="auth_type" id="auth_key" value="key" onchange="toggleAuthFields()">
                                <label class="form-check-label" for="auth_key">
                                    <i class="bi bi-file-earmark-lock me-1"></i>密钥认证
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 密码认证字段 -->
                    <div class="mb-3" id="passwordField">
                        <label for="password" class="form-label">密码 <span class="text-danger">*</span></label>
                        <input type="password" class="form-control claude-input" id="password" name="password">
                        <div class="form-text">请输入SSH连接密码</div>
                    </div>
                    
                    <!-- 密钥认证字段 -->
                    <div class="mb-3 d-none" id="keyField">
                        <label for="key_path" class="form-label">密钥文件路径 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control claude-input" id="key_path" name="key_path" placeholder="如：/home/user/.ssh/id_rsa">
                        <div class="form-text">请输入SSH私钥文件的绝对路径</div>
                    </div>
                    
                    <!-- 用户可选择设置 -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="user_selectable" name="user_selectable" checked>
                            <label class="form-check-label" for="user_selectable">
                                <i class="bi bi-people me-1"></i>
                                用户可选择此服务器
                            </label>
                            <div class="form-text">关闭后，用户在申请权限时将看不到此服务器</div>
                        </div>
                    </div>
                    
                    <!-- 位置信息 -->
                    <hr class="my-4">
                    <div class="collapse-section">
                        <button type="button" class="collapse-header" data-bs-toggle="collapse" data-bs-target="#locationInfo" aria-expanded="false">
                            <div class="d-flex align-items-center justify-content-between w-100">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-geo-alt me-2"></i>
                                    <span>位置信息 (可选)</span>
                                </div>
                                <i class="bi bi-chevron-down collapse-icon"></i>
                            </div>
                        </button>
                        
                        <div class="collapse" id="locationInfo">
                            <div class="collapse-content">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="location" class="form-label">部署位置</label>
                                        <input type="text" class="form-control claude-input" id="location" name="location" placeholder="如：北京机房">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="datacenter" class="form-label">部署机房</label>
                                        <input type="text" class="form-control claude-input" id="datacenter" name="datacenter" placeholder="如：A区机房">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="rack" class="form-label">部署机柜</label>
                                        <input type="text" class="form-control claude-input" id="rack" name="rack" placeholder="如：R-A01">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="rack_position" class="form-label">柜内位置</label>
                                        <input type="text" class="form-control claude-input" id="rack_position" name="rack_position" placeholder="如：U1-U2">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 配置信息 -->
                    <hr class="my-4">
                    <div class="collapse-section">
                        <button type="button" class="collapse-header" data-bs-toggle="collapse" data-bs-target="#configInfo" aria-expanded="false">
                            <div class="d-flex align-items-center justify-content-between w-100">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-cpu me-2"></i>
                                    <span>配置信息 (可选)</span>
                                </div>
                                <i class="bi bi-chevron-down collapse-icon"></i>
                            </div>
                        </button>
                        
                        <div class="collapse" id="configInfo">
                            <div class="collapse-content">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="cpu_model" class="form-label">CPU型号</label>
                                        <input type="text" class="form-control claude-input" id="cpu_model" name="cpu_model" placeholder="如：Intel Xeon E5-2620">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="cpu_count" class="form-label">CPU数量</label>
                                        <input type="number" class="form-control claude-input" id="cpu_count" name="cpu_count" min="1" placeholder="如：2">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="gpu_model" class="form-label">GPU型号</label>
                                        <input type="text" class="form-control claude-input" id="gpu_model" name="gpu_model" placeholder="如：NVIDIA RTX 4090">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="gpu_count" class="form-label">GPU数量</label>
                                        <input type="number" class="form-control claude-input" id="gpu_count" name="gpu_count" min="0" placeholder="如：1">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="memory_model" class="form-label">内存型号</label>
                                        <input type="text" class="form-control claude-input" id="memory_model" name="memory_model" placeholder="如：DDR4-3200">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="memory_count" class="form-label">内存数量(GB)</label>
                                        <input type="number" class="form-control claude-input" id="memory_count" name="memory_count" min="1" placeholder="如：32">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="ssd_model" class="form-label">SSD型号</label>
                                        <input type="text" class="form-control claude-input" id="ssd_model" name="ssd_model" placeholder="如：Samsung 980 PRO">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="ssd_count" class="form-label">SSD数量(GB)</label>
                                        <input type="number" class="form-control claude-input" id="ssd_count" name="ssd_count" min="1" placeholder="如：1024">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="claude-btn claude-btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="claude-btn claude-btn-primary">
                        <i class="bi bi-plus-circle"></i> 添加服务器
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 编辑服务器模态框 -->
<div class="modal fade" id="editServerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content claude-modal">
            <div class="modal-header">
                <h5 class="modal-title" style="color: var(--claude-text-primary); font-weight: 600;">
                    <i class="bi bi-pencil me-2" style="color: var(--claude-warning);"></i>
                    编辑服务器
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editServerForm">
                <input type="hidden" id="edit_server_id" name="server_id">
                <input type="hidden" name="action" value="edit">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_name" class="form-label">服务器名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control claude-input" id="edit_name" name="name" required>
                        <div class="form-text">给服务器一个易识别的名称</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_host" class="form-label">主机地址 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control claude-input" id="edit_host" name="host" 
                               placeholder="192.168.1.100 或 server.example.com" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_port" class="form-label">SSH端口</label>
                        <input type="number" class="form-control claude-input" id="edit_port" name="port" value="22" min="1" max="65535">
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_username" class="form-label">用户名 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control claude-input" id="edit_username" name="username" required>
                    </div>
                    
                    <!-- 认证类型选择 -->
                    <div class="mb-3">
                        <label class="form-label">认证方式 <span class="text-danger">*</span></label>
                        <div class="auth-type-selection">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="auth_type" id="edit_auth_password" value="password" checked onchange="toggleEditAuthFields()">
                                <label class="form-check-label" for="edit_auth_password">
                                    <i class="bi bi-key me-1"></i>密码认证
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="auth_type" id="edit_auth_key" value="key" onchange="toggleEditAuthFields()">
                                <label class="form-check-label" for="edit_auth_key">
                                    <i class="bi bi-file-earmark-lock me-1"></i>密钥认证
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 密码认证字段 -->
                    <div class="mb-3" id="editPasswordField">
                        <label for="edit_password" class="form-label">密码</label>
                        <input type="password" class="form-control claude-input" id="edit_password" name="password">
                        <div class="form-text">留空表示不修改密码</div>
                    </div>
                    
                    <!-- 密钥认证字段 -->
                    <div class="mb-3 d-none" id="editKeyField">
                        <label for="edit_key_path" class="form-label">密钥文件路径</label>
                        <input type="text" class="form-control claude-input" id="edit_key_path" name="key_path" placeholder="如：/home/user/.ssh/id_rsa">
                        <div class="form-text">留空表示不修改密钥路径</div>
                    </div>
                    
                    <!-- 用户可选择设置 -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="edit_user_selectable" name="user_selectable" checked>
                            <label class="form-check-label" for="edit_user_selectable">
                                <i class="bi bi-people me-1"></i>
                                用户可选择此服务器
                            </label>
                            <div class="form-text">关闭后，用户在申请权限时将看不到此服务器</div>
                        </div>
                    </div>
                    
                    <!-- 位置信息 -->
                    <hr class="my-4">
                    <div class="collapse-section">
                        <button type="button" class="collapse-header" data-bs-toggle="collapse" data-bs-target="#editLocationInfo" aria-expanded="false">
                            <div class="d-flex align-items-center justify-content-between w-100">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-geo-alt me-2"></i>
                                    <span>位置信息 (可选)</span>
                                </div>
                                <i class="bi bi-chevron-down collapse-icon"></i>
                            </div>
                        </button>
                        
                        <div class="collapse" id="editLocationInfo">
                            <div class="collapse-content">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="edit_location" class="form-label">部署位置</label>
                                        <input type="text" class="form-control claude-input" id="edit_location" name="location" placeholder="如：北京机房">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="edit_datacenter" class="form-label">部署机房</label>
                                        <input type="text" class="form-control claude-input" id="edit_datacenter" name="datacenter" placeholder="如：A区机房">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="edit_rack" class="form-label">部署机柜</label>
                                        <input type="text" class="form-control claude-input" id="edit_rack" name="rack" placeholder="如：R-A01">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="edit_rack_position" class="form-label">柜内位置</label>
                                        <input type="text" class="form-control claude-input" id="edit_rack_position" name="rack_position" placeholder="如：U1-U2">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 配置信息 -->
                    <hr class="my-4">
                    <div class="collapse-section">
                        <button type="button" class="collapse-header" data-bs-toggle="collapse" data-bs-target="#editConfigInfo" aria-expanded="false">
                            <div class="d-flex align-items-center justify-content-between w-100">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-cpu me-2"></i>
                                    <span>配置信息 (可选)</span>
                                </div>
                                <i class="bi bi-chevron-down collapse-icon"></i>
                            </div>
                        </button>
                        
                        <div class="collapse" id="editConfigInfo">
                            <div class="collapse-content">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="edit_cpu_model" class="form-label">CPU型号</label>
                                        <input type="text" class="form-control claude-input" id="edit_cpu_model" name="cpu_model" placeholder="如：Intel Xeon E5-2620">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="edit_cpu_count" class="form-label">CPU数量</label>
                                        <input type="number" class="form-control claude-input" id="edit_cpu_count" name="cpu_count" min="1" placeholder="如：2">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="edit_gpu_model" class="form-label">GPU型号</label>
                                        <input type="text" class="form-control claude-input" id="edit_gpu_model" name="gpu_model" placeholder="如：NVIDIA RTX 4090">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="edit_gpu_count" class="form-label">GPU数量</label>
                                        <input type="number" class="form-control claude-input" id="edit_gpu_count" name="gpu_count" min="0" placeholder="如：1">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="edit_memory_model" class="form-label">内存型号</label>
                                        <input type="text" class="form-control claude-input" id="edit_memory_model" name="memory_model" placeholder="如：DDR4-3200">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="edit_memory_count" class="form-label">内存数量(GB)</label>
                                        <input type="number" class="form-control claude-input" id="edit_memory_count" name="memory_count" min="1" placeholder="如：32">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="edit_ssd_model" class="form-label">SSD型号</label>
                                        <input type="text" class="form-control claude-input" id="edit_ssd_model" name="ssd_model" placeholder="如：Samsung 980 PRO">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="edit_ssd_count" class="form-label">SSD数量(GB)</label>
                                        <input type="number" class="form-control claude-input" id="edit_ssd_count" name="ssd_count" min="1" placeholder="如：1024">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="claude-btn claude-btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="claude-btn claude-btn-warning">
                        <i class="bi bi-check-circle"></i> 保存修改
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.claude-metric-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
    transition: all 0.2s ease;
}

.claude-metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border-color: #cbd5e1;
}

.claude-metric-value {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 4px;
    line-height: 1;
}

.claude-metric-label {
    font-size: 0.875rem;
    color: var(--claude-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.025em;
    font-weight: 500;
}

.server-config-info {
    font-size: 0.875rem;
}

.claude-code {
    background: #f1f5f9;
    color: #475569;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.8rem;
}

.claude-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
}

.claude-badge-success {
    background: #dcfce7;
    color: #166534;
}

.claude-badge-danger {
    background: #fee2e2;
    color: #991b1b;
}

.claude-badge-secondary {
    background: #f1f5f9;
    color: #475569;
}

.claude-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s ease;
    cursor: pointer;
}


.claude-modal {
    border: none;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
}

.claude-modal .modal-header {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-bottom: 1px solid #e2e8f0;
    border-radius: 12px 12px 0 0;
}

.claude-input {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.claude-input:focus {
    border-color: #0369a1;
    box-shadow: 0 0 0 3px rgba(3, 105, 161, 0.1);
}

.table th {
    border-bottom: 2px solid #e2e8f0;
    padding: 12px 8px;
}

.table td {
    padding: 12px 8px;
    vertical-align: middle;
}

.table-hover tbody tr:hover {
    background-color: rgba(3, 105, 161, 0.02);
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.spinning {
    animation: spin 1s linear infinite;
}

/* 折叠功能样式 */
.collapse-section {
    margin-bottom: 0;
}

.collapse-header {
    width: 100%;
    background: none;
    border: none;
    padding: 12px 0;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--claude-text-muted);
    font-size: 0.95rem;
    font-weight: 600;
}

.collapse-header:hover {
    color: var(--claude-text-primary);
    background: rgba(3, 105, 161, 0.02);
    border-radius: 6px;
    padding: 12px 8px;
}

.collapse-icon {
    transition: transform 0.3s ease;
    font-size: 0.8rem;
}

.collapse-header[aria-expanded="true"] .collapse-icon {
    transform: rotate(180deg);
}

.collapse-content {
    padding-top: 16px;
}

.collapse {
    transition: all 0.3s ease;
}

/* 认证类型选择样式 */
.auth-type-selection {
    display: flex;
    gap: 20px;
    margin-top: 8px;
}

.auth-type-selection .form-check {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    background: #ffffff;
    transition: all 0.2s ease;
    cursor: pointer;
    min-width: 140px;
}

.auth-type-selection .form-check:hover {
    border-color: #cbd5e1;
    background: #f8fafc;
}

.auth-type-selection .form-check-input:checked + .form-check-label {
    color: var(--claude-primary);
    font-weight: 600;
}

.auth-type-selection .form-check-input:checked {
    background-color: var(--claude-primary);
    border-color: var(--claude-primary);
}

.auth-type-selection .form-check:has(.form-check-input:checked) {
    border-color: var(--claude-primary);
    background: rgba(3, 105, 161, 0.05);
}

.auth-type-selection .form-check-label {
    margin-bottom: 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    font-size: 0.875rem;
}

.auth-type-selection .form-check-input {
    margin-top: 0;
    margin-right: 8px;
}
</style>

<script>
// 服务器数据
const serversData = {
    {% for server in servers %}
    {{ server.id }}: {
        name: '{{ server.name }}',
        host: '{{ server.host }}',
        port: {{ server.port }},
        username: '{{ server.username }}',
        password: '{{ server.password or "" }}',
        auth_type: '{{ server.auth_type or "password" }}',
        key_path: '{{ server.key_path or "" }}',
        user_selectable: {{ 'true' if server.user_selectable else 'false' }},
        location: '{{ server.location or "" }}',
        datacenter: '{{ server.datacenter or "" }}',
        rack: '{{ server.rack or "" }}',
        rack_position: '{{ server.rack_position or "" }}',
        cpu_model: '{{ server.cpu_model or "" }}',
        cpu_count: {{ server.cpu_count or 'null' }},
        gpu_model: '{{ server.gpu_model or "" }}',
        gpu_count: {{ server.gpu_count or 'null' }},
        memory_model: '{{ server.memory_model or "" }}',
        memory_count: {{ server.memory_count or 'null' }},
        ssd_model: '{{ server.ssd_model or "" }}',
        ssd_count: {{ server.ssd_count or 'null' }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

function editServerById(serverId) {
    const serverData = serversData[serverId];
    if (serverData) {
        editServer(serverId, serverData);
    }
}

function testConnection(serverId) {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    const icon = btn.querySelector('i');
    
    icon.classList.add('spinning');
    btn.innerHTML = '<i class="bi bi-arrow-clockwise spinning"></i>';
    btn.disabled = true;
    
    // 模拟连接测试
    setTimeout(() => {
        // 这里可以调用真实的测试连接API
        fetch(`/api/test_connection/${serverId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('连接测试成功', 'success');
                } else {
                    showToast(`连接测试失败: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                showToast('连接测试失败', 'error');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }, 2000);
}

function editServer(serverId, serverData) {
    // 填充基本编辑表单
    document.getElementById('edit_server_id').value = serverId;
    document.getElementById('edit_name').value = serverData.name || '';
    document.getElementById('edit_host').value = serverData.host || '';
    document.getElementById('edit_port').value = serverData.port || 22;
    document.getElementById('edit_username').value = serverData.username || '';
    
    // 设置认证类型
    const authType = serverData.auth_type || 'password';
    if (authType === 'key') {
        document.getElementById('edit_auth_key').checked = true;
        document.getElementById('edit_key_path').value = serverData.key_path || '';
    } else {
        document.getElementById('edit_auth_password').checked = true;
    }
    document.getElementById('edit_password').value = '';
    
    // 调用切换函数显示正确的字段
    toggleEditAuthFields();
    
    // 设置用户可选择开关状态
    document.getElementById('edit_user_selectable').checked = serverData.user_selectable !== false;
    
    // 填充位置信息
    document.getElementById('edit_location').value = serverData.location || '';
    document.getElementById('edit_datacenter').value = serverData.datacenter || '';
    document.getElementById('edit_rack').value = serverData.rack || '';
    document.getElementById('edit_rack_position').value = serverData.rack_position || '';
    
    // 填充配置信息
    document.getElementById('edit_cpu_model').value = serverData.cpu_model || '';
    document.getElementById('edit_cpu_count').value = serverData.cpu_count || '';
    document.getElementById('edit_gpu_model').value = serverData.gpu_model || '';
    document.getElementById('edit_gpu_count').value = serverData.gpu_count || '';
    document.getElementById('edit_memory_model').value = serverData.memory_model || '';
    document.getElementById('edit_memory_count').value = serverData.memory_count || '';
    document.getElementById('edit_ssd_model').value = serverData.ssd_model || '';
    document.getElementById('edit_ssd_count').value = serverData.ssd_count || '';
    
    // 显示编辑模态框
    const modal = new bootstrap.Modal(document.getElementById('editServerModal'));
    modal.show();
}

function deleteServer(serverId, serverName) {
    if (confirm(`确定要删除服务器 "${serverName}" 吗？\n\n注意：删除后相关的申请记录将无法访问。`)) {
        // 创建删除表单
        const form = document.createElement('form');
        form.method = 'POST';
        form.style.display = 'none';
        
        // 添加必要字段
        const serverIdInput = document.createElement('input');
        serverIdInput.type = 'hidden';
        serverIdInput.name = 'server_id';
        serverIdInput.value = serverId;
        form.appendChild(serverIdInput);
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'delete';
        form.appendChild(actionInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

function showToast(message, type) {
    // 创建简单的toast提示
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 80px; right: 20px; z-index: 1050; min-width: 300px;';
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    // 3秒后自动移除
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 3000);
}

// 服务器搜索和筛选功能
function initServerSearch() {
    const searchInput = document.getElementById('serverSearchInput');
    const clearBtn = document.getElementById('clearSearchBtn');
    const filterButtons = document.querySelectorAll('.filter-status');
    const serverRows = document.querySelectorAll('tbody tr');
    
    let currentFilter = 'all';
    
    // 搜索功能
    function performSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        let visibleCount = 0;
        
        serverRows.forEach(row => {
            const serverName = row.querySelector('.fw-semibold').textContent.toLowerCase();
            const serverHost = row.querySelector('small').textContent.toLowerCase();
            const serverStatus = row.querySelector('.claude-badge').textContent.toLowerCase();
            
            const matchesSearch = !searchTerm || 
                serverName.includes(searchTerm) || 
                serverHost.includes(searchTerm);
            
            const matchesFilter = currentFilter === 'all' || 
                serverStatus.includes(currentFilter === 'online' ? '在线' : 
                                    currentFilter === 'offline' ? '离线' : '未知');
            
            if (matchesSearch && matchesFilter) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // 显示/隐藏清除按钮
        clearBtn.style.display = searchTerm ? 'block' : 'none';
        
        // 更新结果提示
        updateResultCount(visibleCount);
    }
    
    // 防抖搜索
    let searchTimeout;
    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300);
    });
    
    // 清除搜索
    clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        clearBtn.style.display = 'none';
        performSearch();
        searchInput.focus();
    });
    
    // 状态筛选
    filterButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            currentFilter = btn.dataset.status;
            
            // 更新筛选按钮文本
            const dropdownBtn = document.querySelector('.dropdown-toggle');
            const statusText = btn.textContent;
            dropdownBtn.innerHTML = `<i class="bi bi-funnel"></i> ${statusText}`;
            
            performSearch();
        });
    });
    
    // 更新结果计数
    function updateResultCount(count) {
        let countElement = document.getElementById('searchResultCount');
        if (!countElement) {
            countElement = document.createElement('small');
            countElement.id = 'searchResultCount';
            countElement.className = 'text-muted ms-2';
            document.querySelector('.claude-card-header h5').appendChild(countElement);
        }
        
        if (searchInput.value.trim() || currentFilter !== 'all') {
            countElement.textContent = `(${count} 个结果)`;
        } else {
            countElement.textContent = '';
        }
    }
}

// 表单验证
document.addEventListener('DOMContentLoaded', function() {
    // 初始化搜索功能
    if (document.getElementById('serverSearchInput')) {
        initServerSearch();
    }
    function validateForm(form) {
        const nameInput = form.querySelector('input[name="name"]');
        const hostInput = form.querySelector('input[name="host"]');
        const usernameInput = form.querySelector('input[name="username"]');
        
        const name = nameInput.value.trim();
        const host = hostInput.value.trim();
        const username = usernameInput.value.trim();
        
        if (!name || !host || !username) {
            showToast('请填写必填字段', 'error');
            return false;
        }
        
        // 简单的IP/域名格式验证
        const hostPattern = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$|^[a-zA-Z0-9][a-zA-Z0-9\.-]*[a-zA-Z0-9]$/;
        if (!hostPattern.test(host)) {
            showToast('请输入有效的IP地址或域名', 'error');
            hostInput.focus();
            return false;
        }
        
        return true;
    }
    
    // 添加服务器表单验证
    document.getElementById('addServerForm').addEventListener('submit', function(e) {
        if (!validateForm(this)) {
            e.preventDefault();
        }
    });
    
    // 编辑服务器表单验证
    document.getElementById('editServerForm').addEventListener('submit', function(e) {
        if (!validateForm(this)) {
            e.preventDefault();
        }
    });
});

// 认证类型切换函数（添加服务器）
function toggleAuthFields() {
    const passwordRadio = document.getElementById('auth_password');
    const keyRadio = document.getElementById('auth_key');
    const passwordField = document.getElementById('passwordField');
    const keyField = document.getElementById('keyField');
    const passwordInput = document.getElementById('password');
    const keyPathInput = document.getElementById('key_path');
    
    if (passwordRadio.checked) {
        passwordField.classList.remove('d-none');
        keyField.classList.add('d-none');
        passwordInput.required = true;
        keyPathInput.required = false;
        keyPathInput.value = '';
    } else if (keyRadio.checked) {
        passwordField.classList.add('d-none');
        keyField.classList.remove('d-none');
        passwordInput.required = false;
        keyPathInput.required = true;
        passwordInput.value = '';
    }
}

// 认证类型切换函数（编辑服务器）
function toggleEditAuthFields() {
    const passwordRadio = document.getElementById('edit_auth_password');
    const keyRadio = document.getElementById('edit_auth_key');
    const passwordField = document.getElementById('editPasswordField');
    const keyField = document.getElementById('editKeyField');
    const passwordInput = document.getElementById('edit_password');
    const keyPathInput = document.getElementById('edit_key_path');
    
    if (passwordRadio.checked) {
        passwordField.classList.remove('d-none');
        keyField.classList.add('d-none');
        keyPathInput.value = '';
    } else if (keyRadio.checked) {
        passwordField.classList.add('d-none');
        keyField.classList.remove('d-none');
        passwordInput.value = '';
    }
}
</script>
{% endblock %}